# Find Unused

This is a Scala 3 tool to find unused code. It uses the TASTy files generated by the compiler and
[tasty-query](https://github.com/scalacenter/tasty-query) to determine what code is used/unused.

See below for more details on setup and use.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Install and configure](#install-and-configure)
  - [sbt plugin](#sbt-plugin)
  - [Standalone CLI](#standalone-cli)
- [Usage](#usage)
  - [sbt plugin](#sbt-plugin-1)
  - [Standalone CLI](#standalone-cli-1)
    - [Example usage](#example-usage)
- [Exclusions](#exclusions)
  - [Usage in sbt plugin](#usage-in-sbt-plugin)
- [Known issues](#known-issues)
  - [`given`s/`implicit`s summoned with `inline`/macro methods](#givensimplicits-summoned-with-inlinemacro-methods)
  - [`transparent inline` methods](#transparent-inline-methods)
  - [Lack of support for multiple Scala versions](#lack-of-support-for-multiple-scala-versions)
- [Debugging](#debugging)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Install and configure

### sbt plugin

To install the tool in an sbt project, add this to `project/plugins.sbt`, using the version number from the latest
GitHub release:

![GitHub Release](https://img.shields.io/github/v/release/mblink/find-unused)

```scala
resolvers += "bondlink-maven-repo" at "https://maven.bondlink-cdn.com"
addSbtPlugin("bondlink" % "find-unused" % "x.y.z")
```

Then update `build.sbt` to specify which top-level packages should be analyzed for unused code:

```scala
Global / findUnusedPackages := Seq("foo", "bar")
```

### Standalone CLI

To install the tool as a standalone CLI, download `find-unused.jar` from
[the latest GitHub release](https://github.com/mblink/find-unused/releases/latest).

## Usage

### sbt plugin

A few sbt commands are available:

|Command|Description|
|---|---|
|`findUnusedExplicits`|Analyze the configured packages for unused explicit (i.e. non-implicit/given/using) code|
|`findUnusedGivens`|Analyze the configured packages for unused implicit/given/using code|
|`findUnusedImplicits`|An alias for `findUnusedGivens`|
|`findUnusedAll`|Analyze the configured packages for all types of unused code|

### Standalone CLI

You can run the standalone CLI with:

```bash
java -jar /path/to/find-unused.jar
```

There are a couple options you must pass, as well as some optional ones:

|Option|Type|Description|
|---|---|---|
|`--package`|Required, repeated|The packages to analyze|
|`--classpath`|Required, repeated|The full classpath of your code and all dependencies|
|`--exclusion`|Optional, repeated|Code to exclude from unused warnings, see [Exclusions](#exclusions)|
|`--root-directory`|Optional|The path to the root of your codebase; used when reporting code positions|

#### Example usage

```bash
java -jar /path/to/find-unused.jar \
  --root-directory /path/to/your/code \
  --package com.example.foo \
  --package com.example.bar \
  --classpath "$HOME/Library/Caches/Coursier/v1/https/repo1.maven.org/maven2/org/scala-lang/scala-library/3.8.2/scala-library-3.8.2.jar" \
  --classpath ... \
  --exclusion 'src=.*/src_managed/.*' \
  --exclusion 'sym=^com\.example\.MyClass\.(foo|bar)$'
```

## Exclusions

You may wish to exclude some code from being reported as unused. The tool supports two types of exclusions:

|Name|Description|
|---|---|
|`src`|Exclude all code in files that match the given regex|
|`sym`|Exclude all code whose symbols match the given regex|

### Usage in sbt plugin

You can define exclusions using the `findUnusedExclusions` setting:

```scala
Global / findUnusedExclusions := Seq(
  FindUnusedExclusion(src = ".*/src_managed/.*".r),
  FindUnusedExclusion(sym = """^com\\.example\\.MyClass\\.(foo|bar)$""".r),
  FindUnusedExclusion(src = "...".r, sym = "...".r),
)
```

## Known issues

### `given`s/`implicit`s summoned with `inline`/macro methods

As of Scala 3.8.2, the TASTy representation of some `inline` and macro-related methods does not include references to
the `given`/`implicit` instances that they summon -- https://github.com/scala/scala3/issues/22701

This includes:

1. `scala.compiletime.summonAll`
2. `scala.compiletime.summonFrom`
3. `scala.quoted.Expr.summon`
4. Uses of `scala.compiletime.summonInline` in macros

The end result is that any instances that are _only_ resolved by these methods will be reported as unused.

This is especially problematic for derivation, which often uses `summonFrom`. For example, with this code using
[circe](https://github.com/circe/circe) derivation:

```scala
import io.circe.Decoder

case class Foo(int: Int) derives Decoder
case class Bar(foo: Foo) derives Decoder
```

`Foo`'s derived `Decoder` will be reported as unused because circe derivation uses `summonFrom`. The `Decoder` is
required and used by `Bar`'s derived `Decoder`.

### `transparent inline` methods

As of Scala 3.8.2, the TASTy representation of calls to `transparent inline` methods is equivalent to the TASTy
representation of the body of the `transparent inline` method -- there is no indication that the `transparent inline`
method was called.

For example:

```scala
transparent inline def foo(): Int = 1
val bar = foo()
```

The TASTy representation for `val bar` does not include a reference to `transparent inline def foo`, it appears as if
`val bar` is simply defined as

```scala
val bar = 1
```

The end result is that `transparent inline def`s are reported as unused even when they are in fact used.

### Lack of support for multiple Scala versions

At the moment this tool only works when all projects in your build use the same Scala version, and that version is
Scala 3.8.x.

Support may be added in the future for multiple Scala versions within the same build or for older Scala 3 versions.

## Debugging

You can use the sbt plugin to generate a `launch.json` config file that can be used in Visual Studio Code to debug `find-unused`.

To debug a project that uses the sbt plugin:

1. Load `sbt` in the project directory
2. Run one of the available sbt commands: `findUnusedExplicitsDebugConfig`, `findUnusedGivensDebugConfig`, or `findUnusedAllDebugConfig`
3. Copy the JSON that's printed out
4. Clone `find-unused`
5. Create `/path/to/find-unused/.vscode/launch.json` using the JSON from step 3
6. Open the `find-unused` directory in VS Code
7. Install and setup [Metals](https://scalameta.org/metals/docs/editors/vscode)
8. Import the sbt build with Metals and wait for completion
9. Set any breakpoints you want in `find-unused` and [start debugging](https://code.visualstudio.com/docs/debugtest/debugging#_start-a-debugging-session)
